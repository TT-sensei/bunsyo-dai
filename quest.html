<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã‚¯ã‚¨ã‚¹ãƒˆ - ç®—æ•°ã‚¯ã‚¨ã‚¹ãƒˆ</title>

<style>
body { font-family: sans-serif; background: #e3f2fd; text-align: center; margin: 0; padding: 20px; }
h1 { color: #1565c0; }

.question-box { background: white; padding: 20px; border-radius: 10px; margin: 20px auto; max-width: 600px; font-size: 1.4rem; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

/* å¼å…¥åŠ›ã‚¨ãƒªã‚¢ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
.formula-area { margin: 20px 0; font-size: 1.5rem; display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap; }
.f-input { font-size: 1.5rem; padding: 10px; width: 60px; text-align: center; border: 2px solid #90caf9; border-radius: 8px; }
.f-select { font-size: 1.5rem; padding: 8px; border: 2px solid #90caf9; border-radius: 8px; background: white; }

button { padding: 12px 20px; margin: 8px; font-size: 1.1rem; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; box-shadow: 0 4px 0 rgba(0,0,0,0.2); transition: transform 0.1s; }
button:active { transform: translateY(4px); box-shadow: none; }

.btn-answer { background: #2e7d32; color: white; width: 200px; display: block; margin: 20px auto; }
.btn-hint { background: #ffb300; color: #333; }
.btn-next { background: #0288d1; color: white; display: none; margin: 20px auto; }
.btn-back { background: #546e7a; color: white; margin-top: 30px; }

.result { font-size: 1.5rem; margin-top: 15px; font-weight: bold; min-height: 40px; }
.coin-get { color: #fbc02d; font-size: 1.2rem; display: none; animation: popIn 0.5s ease; }

@keyframes popIn { 0% { transform: scale(0); } 80% { transform: scale(1.2); } 100% { transform: scale(1); } }
</style>
</head>

<body>

<h1>âš”ï¸ ã‚¯ã‚¨ã‚¹ãƒˆ</h1>

<div class="question-box">
  <div id="q-text">ã‚ˆã¿ã“ã¿ä¸­...</div>
</div>

<div class="formula-area">
  å¼ï¼š
  <input type="number" id="f-num1" class="f-input">
  <select id="f-op" class="f-select">
    <option value="?">?</option>
    <option value="+">ï¼‹</option>
    <option value="-">ï¼</option>
    <option value="Ã—">Ã—</option>
    <option value="Ã·">Ã·</option>
  </select>
  <input type="number" id="f-num2" class="f-input">
  ï¼
  <input type="number" id="f-ans" class="f-input" style="width: 80px;" placeholder="ã“ãŸãˆ">
</div>

<div>
  <button class="btn-hint" onclick="showHint()">ğŸ’¡ ãƒ’ãƒ³ãƒˆ</button>
  <button class="btn-answer" id="btn-answer" onclick="checkAnswer()">ğŸ“ ã“ãŸãˆã‚ã‚ã›</button>
  <button class="btn-next" id="btn-next" onclick="nextQuestion()">â¡ï¸ ã¤ãã®ã‚‚ã‚“ã ã„</button>
</div>

<div id="result" class="result"></div>
<div id="coin-get" class="coin-get">âœ¨ ã‚³ã‚¤ãƒ³ +1 & ã‘ã„ã‘ã‚“ã¡ +1 âœ¨</div>

<div>
  <button class="btn-back" onclick="goBack()">ğŸ  æ‹ ç‚¹ã«ã‚‚ã©ã‚‹</button>
</div>

<script src="data.js"></script>

<script>
// ------------------------
// URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾—
// ------------------------
const params = new URLSearchParams(window.location.search);
const grade = Number(params.get("grade"));
const mode = params.get("mode");

let currentQuestion = null;
let isAnswered = false; // ã™ã§ã«æ­£è§£ã—ãŸã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°

// ------------------------
// å•é¡Œã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
// ------------------------
function loadQuestion() {
  isAnswered = false;
  document.getElementById("btn-answer").style.display = "block";
  document.getElementById("btn-next").style.display = "none";
  document.getElementById("result").innerText = "";
  document.getElementById("coin-get").style.display = "none";
  
  // å…¥åŠ›æ¬„ã‚’ãƒªã‚»ãƒƒãƒˆ
  document.getElementById("f-num1").value = "";
  document.getElementById("f-op").value = "?";
  document.getElementById("f-num2").value = "";
  document.getElementById("f-ans").value = "";

  // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
  let filtered = questTemplates.filter(q => q.grade === grade);
  if(mode === "train_add") filtered = filtered.filter(q => q.operation === "add");
  if(mode === "train_sub") filtered = filtered.filter(q => q.operation === "sub");
  if(mode === "train_mul") filtered = filtered.filter(q => q.operation === "mul");
  if(mode === "train_div") filtered = filtered.filter(q => q.operation === "div");

  // ãƒ©ãƒ³ãƒ€ãƒ é¸æŠã—ã¦ç”Ÿæˆï¼ˆdata.js ã®é–¢æ•°ã‚’ä½¿ç”¨ï¼ï¼‰
  const template = choice(filtered);
  currentQuestion = generateQuestion(template);

  // ç”»é¢ã«è¡¨ç¤º
  document.getElementById("q-text").innerText = currentQuestion.text;
}

// ------------------------
// ç­”ãˆåˆã‚ã›ï¼ˆå¼ã¨ç­”ãˆã®ä¸¡æ–¹ã‚’ãƒã‚§ãƒƒã‚¯ï¼‰
// ------------------------
function checkAnswer() {
  if (isAnswered) return; // é€£ç¶šã‚¿ãƒƒãƒ—é˜²æ­¢

  const uNum1 = Number(document.getElementById("f-num1").value);
  const uOp = document.getElementById("f-op").value;
  const uNum2 = Number(document.getElementById("f-num2").value);
  const uAns = Number(document.getElementById("f-ans").value);
  const resultText = document.getElementById("result");

  // æ­£è§£ã®è¨˜å·ã‚’åˆ¤å®š
  let correctOp = "?";
  if (currentQuestion.operation === "add") correctOp = "+";
  if (currentQuestion.operation === "sub") correctOp = "-";
  if (currentQuestion.operation === "mul") correctOp = "Ã—";
  if (currentQuestion.operation === "div") correctOp = "Ã·";

  // ãŸã—ç®—ãƒ»ã‹ã‘ç®—ã¯æ•°å­—ãŒé€†ã§ã‚‚OKã«ã™ã‚‹ï¼ˆä¾‹ï¼š3+4 ã¨ 4+3ï¼‰
  let isFormulaCorrect = false;
  if (currentQuestion.operation === "add" || currentQuestion.operation === "mul") {
      isFormulaCorrect = (uOp === correctOp) && 
                         ((uNum1 === currentQuestion.num1 && uNum2 === currentQuestion.num2) || 
                          (uNum1 === currentQuestion.num2 && uNum2 === currentQuestion.num1));
  } else {
      // ã²ãç®—ãƒ»ã‚ã‚Šç®—ã¯é †ç•ªé€šã‚Šã˜ã‚ƒãªã„ã¨ãƒ€ãƒ¡
      isFormulaCorrect = (uOp === correctOp && uNum1 === currentQuestion.num1 && uNum2 === currentQuestion.num2);
  }

  // åˆ¤å®šå‡¦ç†
  if (isFormulaCorrect && uAns === currentQuestion.answer) {
    resultText.innerHTML = "ğŸ‰ å¤§ã›ã„ã‹ã„ï¼ å¼ã‚‚ãƒãƒƒãƒãƒªï¼";
    resultText.style.color = "#2e7d32";
    saveReward(); // ã‚³ã‚¤ãƒ³ã¨çµŒé¨“å€¤ã‚’ä»˜ä¸
    isAnswered = true;
    
    // ãƒœã‚¿ãƒ³ã®åˆ‡ã‚Šæ›¿ãˆ
    document.getElementById("btn-answer").style.display = "none";
    document.getElementById("btn-next").style.display = "block";
  } else if (uAns === currentQuestion.answer) {
    resultText.innerHTML = "âš ï¸ ç­”ãˆã¯åˆã£ã¦ã‚‹ã‘ã©ã€å¼ãŒã¡ãŒã†ã¿ãŸã„â€¦ï¼Ÿ";
    resultText.style.color = "#f57c00";
  } else {
    resultText.innerHTML = "âŒ ã‚‚ã†ã„ã¡ã© è€ƒãˆã¦ã¿ã‚ˆã†ï¼";
    resultText.style.color = "#c62828";
  }
}

// ------------------------
// å ±é…¬ã®ã‚»ãƒ¼ãƒ–æ©Ÿèƒ½
// ------------------------
function saveReward() {
  let exp = parseInt(localStorage.getItem('saved_exp')) || 0;
  let coin = parseInt(localStorage.getItem('saved_coin')) || 10;
  let solvedCount = parseInt(localStorage.getItem('saved_solved_count')) || 0;
  let level = parseInt(localStorage.getItem('saved_level')) || 1;

  exp += 1;
  coin += 1;
  solvedCount += 1;

  // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—åˆ¤å®šï¼ˆ5EXPã”ã¨ã«1ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼‰
  if (exp >= 5) {
      exp = 0;
      level += 1;
      alert(`ğŸŒŸ ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼ ãƒ¬ãƒ™ãƒ« ${level} ã«ãªã£ãŸã‚ˆï¼`);
  }

  localStorage.setItem('saved_exp', exp);
  localStorage.setItem('saved_coin', coin);
  localStorage.setItem('saved_solved_count', solvedCount);
  localStorage.setItem('saved_level', level);

  document.getElementById("coin-get").style.display = "block";
}

// ------------------------
// ãƒ’ãƒ³ãƒˆï¼ˆå•é¡Œæ–‡ã®è‰²ã‚’å¤‰ãˆã‚‹ï¼‰
// ------------------------
function showHint() {
  let htmlText = currentQuestion.text;
  currentQuestion.keywords.forEach(word => {
    htmlText = htmlText.replaceAll(word,
      `<span style="color:#e53935; font-weight:bold; background:#ffcdd2; padding:0 3px; border-radius:3px;">${word}</span>`
    );
  });
  document.getElementById("q-text").innerHTML = htmlText;
}

function nextQuestion() {
  loadQuestion();
}

function goBack() {
  window.location.href = "index.html";
}

// èµ·å‹•æ™‚ã«æœ€åˆã®å•é¡Œã‚’èª­ã¿è¾¼ã‚€
window.onload = loadQuestion;
</script>

</body>
</html>
